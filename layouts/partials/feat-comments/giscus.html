<!-- Check parameters -->
{{ if not (isset site.Params.anubis2.services.giscus "repo") }}
    {{ errorf "Anubis2: You enabled params.anubis2.services.giscus, but the parameter 'params.anubis2.services.giscus.repo' is not set." }}
{{ end }}

{{ if not (isset site.Params.anubis2.services.giscus "repoid") }}
    {{ errorf "Anubis2: You enabled params.anubis2.services.giscus, but the parameter 'params.anubis2.services.giscus.repoId' is not set." }}
{{ end }}

{{ if not (isset site.Params.anubis2.services.giscus "category") }}
    {{ errorf "Anubis2: You enabled params.anubis2.services.giscus, but the parameter 'params.anubis2.services.giscus.category' is not set." }}
{{ end }}

{{ if not (isset site.Params.anubis2.services.giscus "categoryid") }}
    {{ errorf "Anubis2: You enabled params.anubis2.services.giscus, but the parameter 'params.anubis2.services.giscus.categoryId' is not set." }}
{{ end }}


{{ $theme := "preferred_color_scheme" }}
{{ $mapping := site.Params.anubis2.services.giscus.dataMapping | default "og:title" }} 
{{ $language := site.Params.anubis2.services.giscus.language | default "en" }} 
{{ $lazyload := site.Params.anubis2.services.giscus.lazyLoad | default false }} 

{{ $params := partial "params-helper.html" . }}

<script>
        function detectCurrentScheme2() {
                const defaultTheme = "{{ $params.colorTheme }}";
                if (localStorage !== null && localStorage.getItem("user-color-scheme")) {
                        return localStorage.getItem("user-color-scheme");
                }
                if (defaultTheme === "dark" || defaultTheme === "light") {
                        return defaultTheme;
                }
                return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }

        let giscusTheme = detectCurrentScheme2();
        let giscusAttributes = {
                src: "https://giscus.app/client.js",
                "data-repo": "{{- site.Params.anubis2.services.giscus.repo -}}",
                "data-repo-id": "{{- site.Params.anubis2.services.giscus.repoId -}}",
                "data-category": "{{- site.Params.anubis2.services.giscus.category -}}",
                "data-category-id": "{{- site.Params.anubis2.services.giscus.categoryId -}}",
                "data-mapping": "{{ $mapping }}",
                "data-strict": "0",
                "data-reactions-enabled": "1",
                "data-emit-metadata": "0",
                "data-input-position": "bottom",
                "data-theme": giscusTheme,
                "data-lang": "{{ $language }}",
                crossorigin: "anonymous",
                lazyload: "{{ $lazyload }}",
                async: true,
        };
        let main = document.querySelector("main");
        let giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
        main.appendChild(giscusScript);
</script>
